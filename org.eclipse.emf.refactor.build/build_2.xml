<?xml version="1.0" encoding="UTF-8"?>
<!--

IMPORTANT: Run it in the same JRE as the workspace. 
Run AS -> ANT Build.. -> JRE -> Run in the same JRE as the workspace.

-->
<!--project default="feature.publish" name="build.site" basedir="."-->
<project default="download.page.generate" name="build.site" basedir=".">

	<property name="home" location=""/>
	<property name="build.dir" location="build"/>
	<property file="qualifier.txt" prefix="input"/>
	<property name="resources.dir" location="resources"/>
	<property name="repository.name" value="updatesite"/>
	<property name="release.no" value="0.6.0"/>
	
	<!-- Read Qualifier from file: -->
	<target name="init">
		<property name="qualifier" value="${input.qualifier}"/>
	</target>    		

	<!-- Generate update site: -->
	<target name="site.add" depends="init">
		<copy todir="${build.dir}/${repository.name}/" overwrite="true">
		    <fileset dir="${resources.dir}/site">
 		   	  <exclude name="site.xml"/>
		    </fileset>
	    </copy>
<echo file="${build.dir}/${repository.name}/site.xml" append="false">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;site&gt;
   &lt;feature url="features/org.eclipse.emf.refactor.generator.feature_${release.no}.${qualifier}.jar" id="org.eclipse.emf.refactor.generator.feature" version="${release.no}.${qualifier}"&gt;
      &lt;category name="org.eclipse.emf.refactor.BASIC"/&gt;
   &lt;/feature&gt;
   &lt;feature url="features/org.eclipse.emf.refactor.runtime.feature_${release.no}.${qualifier}.jar" id="org.eclipse.emf.refactor.runtime.feature" version="${release.no}.${qualifier}"&gt;
      &lt;category name="org.eclipse.emf.refactor.BASIC"/&gt;
   &lt;/feature&gt;
   &lt;feature url="features/org.eclipse.emf.refactor.henshin.feature_${release.no}.${qualifier}.jar" id="org.eclipse.emf.refactor.henshin.feature" version="${release.no}.${qualifier}"&gt;
      &lt;category name="org.eclipse.emf.refactor.EXTENSION"/&gt;
   &lt;/feature&gt;
   &lt;feature url="features/org.eclipse.emf.refactor.examples.feature_${release.no}.${qualifier}.jar" id="org.eclipse.emf.refactor.examples.feature" version="${release.no}.${qualifier}"&gt;
      &lt;category name="org.eclipse.emf.refactor.EXTENSION"/&gt;
   &lt;/feature&gt;	
   &lt;category-def name="org.eclipse.emf.refactor.BASIC" label="Emf Refactor" version="${release.no}.${qualifier}"&gt;
      &lt;description&gt;
         Emf Refactor
      &lt;/description&gt;
   &lt;/category-def&gt;
   &lt;category-def name="org.eclipse.emf.refactor.EXTENSION" label="EMF Refactor Extensions" version="${release.no}.${qualifier}"&gt;
      &lt;description&gt;
         EMF Refactor Extensions
      &lt;/description&gt;
   &lt;/category-def&gt;
&lt;/site&gt;
</echo>
	</target>    		

	<!-- Publish update site: -->
	<target name="feature.publish" depends="site.add">	
		<eclipse.publish.featuresAndBundles
			 site="file:${build.dir}/${repository.name}/site.xml"
			 categoryversion="${release.no}.${qualifier}"
			 repository="file:${build.dir}/${repository.name}" 			  
			 compress="true"			 
			 >
		     <features dir="${build.dir}/source/features/" includes="*.jar"/>
		     <bundles dir="${build.dir}/source/plugins/" includes="*.jar"/>
		</eclipse.publish.featuresAndBundles>
		<zip destfile="${build.dir}/refactor-${release.no}.${qualifier}.jar">
			<fileset dir="${build.dir}/${repository.name}/"/>
		</zip>
	</target>    		

	<!-- Cleanup: -->
	<target name="cleanup" depends="feature.publish">
		<delete includeEmptyDirs="true">
			<fileset dir="${build.dir}/${repository.name}/"/>
			<fileset dir="${build.dir}/source/"/>
		</delete>
	</target>    		
	

	<!-- Publish update site: -->
	<target name="download.page.generate" depends="cleanup">
		<tstamp>
			<format property="timestamp" pattern="MMM dd, yyyy HH:mm" />
		</tstamp>
		<!-- Copy Release: -->
		<delete failonerror="false">
			<fileset dir="../refactor/downloads/" includes="refactor-${release.no}.*.jar"/>
		</delete>
		<copy todir="../refactor/downloads/">
		    <fileset file="${build.dir}/refactor-${release.no}.${qualifier}.jar"/>
	    </copy>
		
		<!-- Generate Download-File: -->
		<copy todir="${build.dir}/web-eclipse">
		    <fileset dir="resources/web-eclipse" includes="*"/>
	    </copy>
<echo file="${build.dir}/web-eclipse/downloads_1.php" append="true">
&lt;h2&gt;Version ${release.no}&lt;/h2&gt;
&lt;ul class="midlist"&gt;
    &lt;li&gt;&lt;a href="downloads/refactor-${release.no}.${qualifier}.jar"&gt;refactor-${release.no}.${qualifier}.jar&lt;/a&gt; (released ${timestamp})&lt;/li&gt;
&lt;/ul&gt;
</echo>
		<concat destfile="${build.dir}/web-eclipse/downloads.php">
		    <fileset dir="${build.dir}/web-eclipse" includes="downloads_*.php"/>
		</concat>
		
		<!-- Update Download-File on website: -->
		<copy todir="../refactor/" overwrite="true">
		    <fileset file="${build.dir}/web-eclipse/downloads.php"/>
	    </copy>

		<delete includeEmptyDirs="true" failonerror="false">
			<fileset dir="${build.dir}/web-eclipse/"/>
		</delete>
		
	</target>    		

	
</project>
